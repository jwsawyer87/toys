#! /usr/bin/env python

import sys
import time
import datetime
import subprocess

if len(sys.argv) != 2:
  sys.stderr.write('Syntax: {pgm} IP|HOST\n'.format(pgm=sys.argv[0]))
  exit(1)

last_time = None
last_state = None
host = sys.argv[1]
cmd = ['ping', '-w5', '-c1', host]

while True:
  now = datetime.datetime.now()
  p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  (stdout, stderr) = p.communicate()
  rc = p.wait()
  state = 'UP' if rc == 0 else 'DOWN'
  if state != last_state:
    if last_state is not None:
      sys.stdout.write('\n')
    last_time = now
  elif last_state:
    sys.stdout.write('\r')
  elapsed = now - (last_time if last_time else now)
  sys.stdout.write('{now} {host} {state:<4} {elapsed}'.format(**locals()))
  last_state = state

  time.sleep(5)
